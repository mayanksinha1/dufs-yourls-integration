services:
  mysql-ssl:
    build:
      context: ./mysql-ssl
      dockerfile: Dockerfile
    container_name: mysql-ssl
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-yourls}
      MYSQL_USER: ${MYSQL_USER:-yourls_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-yourls_password}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql-ssl/certs/ca.pem:/etc/mysql/ssl/ssl_ca.pem:ro
      - ./mysql-ssl/certs/server-cert.pem:/etc/mysql/ssl/server-cert.pem:ro
      - ./mysql-ssl/certs/server-key.pem:/etc/mysql/ssl/server-key.pem:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}", "--ssl-mode=REQUIRED", "--ssl-ca=/etc/mysql/ssl/ssl_ca.pem"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  yourls:
    build:
      context: ./yourls
      dockerfile: Dockerfile
    container_name: yourls
    depends_on:
      mysql-ssl:
        condition: service_healthy
    environment:
      YOURLS_DB_HOST: mysql-ssl
      YOURLS_DB_USER: ${MYSQL_USER:-yourls_user}
      YOURLS_DB_PASS: ${MYSQL_PASSWORD:-yourls_password}
      YOURLS_DB_NAME: ${MYSQL_DATABASE:-yourls}
      YOURLS_SITE: ${YOURLS_SITE:-http://localhost:8080}
      YOURLS_USER: ######update your username here ${YOURLS_USER:-admin}#########
      YOURLS_PASS: ######update your password here ${YOURLS_PASS:-admin}#########
      YOURLS_COOKIEKEY: ${YOURLS_COOKIEKEY:-change-this-cookie-key-to-something-random}
      YOURLS_UNIQUE_URLS: ${YOURLS_UNIQUE_URLS:-true}
    ports:
      - "${YOURLS_PORT:-8080}:8080"
    volumes:
      - yourls_data:/var/www/html/user
      - ./mysql-ssl/certs/ca.pem:/etc/ssl/mysql/ca.pem:ro
    networks:
      - app-network
    restart: unless-stopped

  dufs:
    build:
      context: ./dufs
      dockerfile: Dockerfile
    container_name: dufs
    ports:
      - "${DUFS_PORT:-5000}:5000"
    volumes:
      - dufs_data:/data
    networks:
      - app-network
    restart: unless-stopped

volumes:
  mysql_data:
    driver: local
  yourls_data:
    driver: local
  dufs_data:
    driver: local

networks:
  app-network:
    driver: bridge

